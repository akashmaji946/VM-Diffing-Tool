{% extends 'base.html' %}
{% block title %}File Compare{% endblock %}
{% block content %}
<h2>Compare Files (Side-by-Side)</h2>
<form method="post">
  <fieldset>
    <legend>First File</legend>
    <div class="grid">
      <label>Disk Path 1
        <input type="text" name="disk_path_1" value="{{ result.disk1 if result else '' }}" placeholder="/path/to/disk1.qcow2" required />
      </label>
      <label>Guest File Path 1
        <input type="text" name="file_path_1" value="{{ result.path1 if result else '' }}" placeholder="/etc/hosts" required />
      </label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Second File</legend>
    <div class="grid">
      <label>Disk Path 2
        <input type="text" name="disk_path_2" value="{{ result.disk2 if result else '' }}" placeholder="/path/to/disk2.qcow2" required />
      </label>
      <label>Guest File Path 2
        <input type="text" name="file_path_2" value="{{ result.path2 if result else '' }}" placeholder="/etc/hosts" required />
      </label>
    </div>
  </fieldset>

  <label>
    <input type="checkbox" name="binary" {% if result and result.binary %}checked{% endif %} /> Binary (hex)
  </label>
  <button type="submit">Compare</button>
</form>

{% if result is not none %}
  <h3>Result</h3>
  <div style="margin-bottom: 1rem;">
    <button id="downloadJson" class="outline" style="margin-right: 0.5rem;">
      ðŸ“¥ Download JSON
    </button>
    <button id="exportPdf" class="outline">
      ðŸ“„ Export PDF
    </button>
  </div>
  <details open>
    <summary>Diff: {{ result.disk1 }}:{{ result.path1 }} â‡„ {{ result.disk2 }}:{{ result.path2 }}</summary>
    <style>
      /* Improve difflib HtmlDiff default table aesthetics to blend with Pico and fit side-by-side */
      /* Make the page a bit wider on this screen to avoid cramped layout */
      main.container { max-width: min(1600px, 95vw); }

      .diff-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border: 1px solid var(--muted-border-color);
        border-radius: .5rem;
        background: var(--card-background-color, transparent);
      }
      table.diff {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.9rem;
        border-collapse: separate;
        border-spacing: 0;
        width: max-content; /* allow growing to content width */
        min-width: 100%; /* but never smaller than container */
        min-inline-size: 100%;
        table-layout: auto; /* let browser size columns naturally */
      }
      .diff th, .diff td {
        border: 1px solid var(--muted-border-color);
        padding: .25rem .5rem;
        vertical-align: top;
        white-space: pre-wrap; /* allow normal wrapping by default */
        overflow-wrap: normal;
        word-break: normal;
        box-sizing: border-box;
      }
      /* Do NOT wrap the main TEXT columns (data cells only); let them scroll horizontally */
      table.diff td:nth-child(3),
      table.diff td:nth-child(6) {
        white-space: pre !important; /* preserve and do not wrap code */
        overflow-wrap: normal !important;
        word-break: normal !important;
      }
      .diff .diff_header { background: rgba(127,127,127,.15); }
      .diff .diff_next { background: transparent; }
      .diff .diff_add { background: rgba(0,200,0,.12); }
      .diff .diff_chg { background: rgba(240,160,0,.15); }
      .diff .diff_sub { background: rgba(255,0,0,.12); }
      /* Column sizing: HtmlDiff columns are marker, lineno, text, marker, lineno, text */
      .diff td:nth-child(1), .diff th:nth-child(1),
      .diff td:nth-child(4), .diff th:nth-child(4) { width: 2ch; }
      .diff td:nth-child(2), .diff th:nth-child(2),
      .diff td:nth-child(5), .diff th:nth-child(5) { width: 7ch; }
      /* Let text columns take remaining space evenly */
      .diff td:nth-child(3), .diff th:nth-child(3) { width: 1%; }
      .diff td:nth-child(6), .diff th:nth-child(6) { width: 1%; }

      /* Hide HtmlDiff's tiny next-change link ("t") to reduce visual clutter */
      .diff .diff_next a { display: none; }
    </style>
    <div class="diff-wrapper">
      {{ result.diff_html | safe }}
    </div>
    <p class="mono">
      Left exists: {{ 'Yes' if result.exists1 else 'No' }} | Right exists: {{ 'Yes' if result.exists2 else 'No' }}
    </p>
  </details>
  
  <script>
    (function(){
      const compareData = {
        disk1: "{{ result.disk1 }}",
        path1: "{{ result.path1 }}",
        disk2: "{{ result.disk2 }}",
        path2: "{{ result.path2 }}",
        exists1: {{ 'true' if result.exists1 else 'false' }},
        exists2: {{ 'true' if result.exists2 else 'false' }},
        binary: {{ 'true' if result.binary else 'false' }},
        content1: {{ result.content1 | tojson }},
        content2: {{ result.content2 | tojson }}
      };

      function downloadJSON() {
        const dataStr = JSON.stringify(compareData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'file-compare-' + new Date().toISOString().slice(0,10) + '.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function exportPDF() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert('PDF library not loaded. Please refresh the page.');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 14;
        const contentWidth = pageWidth - (margin * 2);
        const lineHeight = 3.5;
        const boxPadding = 4;
        
        // Add title
        doc.setFontSize(16);
        doc.text('File Comparison Report', margin, 15);
        doc.setFontSize(10);
        doc.text('Generated: ' + new Date().toLocaleString(), margin, 22);
        
        let yPos = 32;
        
        // Helper function to add content box with dynamic height
        function addFileBox(fileNum, diskPath, filePath, exists, content) {
          // Check if we need a new page for header
          if (yPos > pageHeight - 40) {
            doc.addPage();
            yPos = margin;
          }
          
          // File header
          doc.setFontSize(11);
          doc.setFont(undefined, 'bold');
          doc.text('File ' + fileNum + ':', margin, yPos);
          doc.setFont(undefined, 'normal');
          yPos += 5;
          
          doc.setFontSize(8);
          doc.text('VM Disk: ' + diskPath, margin + 2, yPos);
          yPos += 4;
          doc.text('File Path: ' + filePath, margin + 2, yPos);
          yPos += 4;
          doc.text('Exists: ' + (exists ? 'Yes' : 'No'), margin + 2, yPos);
          yPos += 6;
          
          // Prepare content lines
          doc.setFontSize(7);
          doc.setFont('courier', 'normal');
          const contentLines = doc.splitTextToSize(content || '[EMPTY]', contentWidth - (boxPadding * 2));
          
          // Calculate box height needed
          const contentHeight = (contentLines.length * lineHeight) + (boxPadding * 2);
          const boxStartY = yPos;
          
          // Draw content with page breaks if needed
          let currentLine = 0;
          while (currentLine < contentLines.length) {
            // Check if we need a new page
            if (yPos + lineHeight > pageHeight - margin) {
              doc.addPage();
              yPos = margin;
            }
            
            doc.text(contentLines[currentLine], margin + boxPadding, yPos + boxPadding);
            yPos += lineHeight;
            currentLine++;
          }
          
          // Draw box border (simplified - just around first page content)
          doc.setDrawColor(100, 100, 100);
          const boxHeight = Math.min(contentHeight, pageHeight - boxStartY - margin);
          doc.rect(margin, boxStartY, contentWidth, boxHeight);
          
          yPos += boxPadding + 4;
        }
        
        // Add File 1
        addFileBox(1, compareData.disk1, compareData.path1, compareData.exists1, compareData.content1);
        
        // Add some space between files
        yPos += 6;
        
        // Add File 2
        addFileBox(2, compareData.disk2, compareData.path2, compareData.exists2, compareData.content2);
        
        // Add note at bottom
        yPos += 6;
        if (yPos > pageHeight - 20) {
          doc.addPage();
          yPos = margin;
        }
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8);
        doc.text('Note: For detailed side-by-side diff, use the web interface.', margin, yPos);
        yPos += 5;
        doc.text('Binary Mode: ' + (compareData.binary ? 'Yes (Hex)' : 'No (Text)'), margin, yPos);
        
        // Save the PDF
        doc.save('file-compare-' + new Date().toISOString().slice(0,10) + '.pdf');
      }

      document.addEventListener('DOMContentLoaded', function(){
        const downloadBtn = document.getElementById('downloadJson');
        const exportBtn = document.getElementById('exportPdf');
        
        if (downloadBtn) {
          downloadBtn.addEventListener('click', downloadJSON);
        }
        if (exportBtn) {
          exportBtn.addEventListener('click', exportPDF);
        }
      });
    })();
  </script>
{% endif %}
{% endblock %}
