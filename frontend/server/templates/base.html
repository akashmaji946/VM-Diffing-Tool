<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VM Tool Server - {% block title %}{% endblock %}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <!-- DataTables CSS (core) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
  <!-- AG Grid CSS - Both themes -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-grid.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine-dark.css" />
  <style>
    .container { max-width: 1100px; margin: 2rem auto; }
    pre.code { background: #121212; color: #eee; padding: 1rem; border-radius: 8px; white-space: pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    /* Loader overlay */
    #loaderOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #loaderOverlay .loader-card {
      background: rgba(20,20,20,0.9);
      color: #fff;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 0.9rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .spinner {
      width: 56px; height: 56px;
      border: 6px solid #fff; border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* DataTables header sort arrows */
    table.dataTable thead th { overflow: visible; position: relative; }
    table.dataTable thead th.sorting,
    table.dataTable thead th.sorting_asc,
    table.dataTable thead th.sorting_desc,
    table.dataTable thead th[aria-sort] {
      position: relative; /* ensure :after positions correctly */
      padding-right: 1.25em; /* space for arrow */
    }
    table.dataTable thead th.sorting:after,
    table.dataTable thead th.sorting_asc:after,
    table.dataTable thead th.sorting_desc:after,
    table.dataTable thead th[aria-sort]:after {
      content: '\2195'; /* ‚Üï */
      position: absolute;
      right: 0.5em;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9em;
      opacity: 0.6;
    }
    table.dataTable thead th.sorting_asc:after,
    table.dataTable thead th[aria-sort="ascending"]:after { content: '\2191'; opacity: 1; } /* ‚Üë */
    table.dataTable thead th.sorting_desc:after,
    table.dataTable thead th[aria-sort="descending"]:after { content: '\2193'; opacity: 1; } /* ‚Üì */

    /* Global compact scaling */
    html { font-size: 16px; }
    body { font-size: 1rem; }
    h1 { font-size: 2rem; }
    h2 { font-size: 1.8rem; }
    h3 { font-size: 1.6rem; }

    /* Compact form controls */
    :where(input, select, textarea) {
      font-size: 0.9rem;
      padding: 0.35rem 0.5rem;
      min-height: 2rem;
    }
    :where(button, input[type="submit"], input[type="button"]) {
      font-size: 0.9rem;
      padding: 0.35rem 0.6rem;
      min-height: 2rem;
    }
    label { font-size: 0.9rem; }
    fieldset { padding: 0.75rem; }
    legend { font-size: 1rem; }

    /* Tables compactness */
    table { font-size: 0.9rem; }
    table td, table th { padding: 0.35rem 0.5rem; }

    /* Navigation button styling */
    nav ul li a[href="/login"],
    nav ul li a[href="/signup"],
    nav ul li a[href="/logout"] {
      background: linear-gradient(135deg, #4a9fd8 0%, #5db3e8 100%);
      color: #fff !important;
      padding: 0.5rem 1.2rem;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(74, 159, 216, 0.3);
      margin-left: 0.5rem;
    }
    nav ul li a[href="/login"]:hover,
    nav ul li a[href="/signup"]:hover,
    nav ul li a[href="/logout"]:hover {
      background: linear-gradient(135deg, #5db3e8 0%, #4a9fd8 100%);
      box-shadow: 0 4px 12px rgba(74, 159, 216, 0.4);
      transform: translateY(-1px);
    }

    /* Flash messages styling */
    .flash-messages {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      max-width: 450px;
      min-width: 350px;
    }
    .flash-alert {
      background: #2d7a4a;
      color: #fff;
      padding: 0.9rem 1.2rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      font-size: 1rem;
      animation: fadeIn 0.3s ease-out;
    }
    .flash-alert.error {
      background: #a83232;
    }
    .flash-alert.warning {
      background: #b8941f;
    }
    .flash-alert.info {
      background: #2d6ba8;
    }
    .flash-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .flash-close:hover {
      background: rgba(255,255,255,0.2);
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>
<body>
  <!-- Global loader overlay -->
  <div id="loaderOverlay" aria-hidden="true" aria-live="polite">
    <div class="loader-card">
      <div class="spinner" role="progressbar" aria-label="Loading"></div>
      <div class="msg mono">Please wait‚Ä¶</div>
    </div>
  </div>
  <nav class="container">
    <ul>
      <li><strong>VM Tool Server</strong></li>
    </ul>
    <ul>
      {% if current_user.is_authenticated %}
      <li><a href="/">Home</a></li>
      <li><a href="/list-files">List Files</a></li>
      <li><a href="/files-json">Files JSON</a></li>
      <li><a href="/meta">Disk Meta</a></li>
      <li><a href="/file-contents">File Contents</a></li>
      <li><a href="/file-contents-format">Contents Format</a></li>
      <li><a href="/check-exists">Check Exists</a></li>
      <li><a href="/file-compare">File Compare</a></li>
      <li><a href="/files-diff">Difference in Files</a></li>
      <li><a href="/directory-diff">Compare Files In Directory</a></li>
      <li><a href="/compare">Block Compare</a></li>
      <li><a href="/block-data">Block Data Viewer</a></li>
      <li><a href="/block-contents-compare">Block Contents Compare</a></li>
      <li style="margin-left: auto;">
        <span style="color: #888; font-size: 0.9rem;">üë§ {{ current_user.username }}</span>
      </li>
      <li><a href="/logout">Logout</a></li>
      {% else %}
      <li><a href="/login">Login</a></li>
      <li><a href="/signup">Sign Up</a></li>
      {% endif %}
      <li>
        <button id="themeToggle" class="outline" style="padding: 0.4rem 0.8rem; margin: 0;" aria-label="Toggle theme">
          <span id="themeIcon">üåô</span>
        </button>
      </li>
    </ul>
  </nav>

  <!-- Flash messages container -->
  <div class="flash-messages" id="flashMessages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash-alert {{ category }}" role="alert">
            <span>{{ message }}</span>
            <button class="flash-close" onclick="this.parentElement.remove()" aria-label="Close">&times;</button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <main class="container">
    {% block content %}{% endblock %}
  </main>
  <!-- jQuery + DataTables (core) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <!-- AG Grid JS -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Simple loader API
    window.VMTS = (function(){
      const overlay = document.getElementById('loaderOverlay');
      return {
        show(){ if (overlay) overlay.style.display = 'flex'; },
        hide(){ if (overlay) overlay.style.display = 'none'; }
      };
    })();

    // Theme switcher
    (function(){
      const STORAGE_KEY = 'vmtool-theme';
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const html = document.documentElement;

      // Get saved theme or default to light
      function getSavedTheme() {
        return localStorage.getItem(STORAGE_KEY) || 'light';
      }

      // Apply theme to document
      function applyTheme(theme) {
        html.setAttribute('data-theme', theme);
        if (themeIcon) {
          themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        localStorage.setItem(STORAGE_KEY, theme);
        
        // Dispatch custom event for AG Grid theme switching
        window.dispatchEvent(new CustomEvent('themechange', { detail: { theme } }));
      }

      // Toggle theme
      function toggleTheme() {
        const currentTheme = html.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
      }

      // Initialize theme on page load
      applyTheme(getSavedTheme());

      // Add click handler
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }
    })();

    // Show loader on all form submissions
    window.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('form').forEach(function(f){
        f.addEventListener('submit', function(){
          if (window.VMTS) window.VMTS.show();
        });
      });

      // Show loader on same-origin navigation link clicks
      document.addEventListener('click', function(ev){
        const a = ev.target && (ev.target.closest ? ev.target.closest('a[href]') : null);
        if (!a) return;
        // Ignore new tab/window or hash-only links
        if (ev.metaKey || ev.ctrlKey || ev.shiftKey || ev.altKey) return;
        const href = a.getAttribute('href') || '';
        if (href.startsWith('#')) return;
        try {
          const url = new URL(href, window.location.origin);
          if (url.origin !== window.location.origin) return; // external
          if (window.VMTS) window.VMTS.show();
        } catch { /* noop */ }
      }, true);

      // Ensure loader is hidden after render
      if (window.VMTS) window.VMTS.hide();
    });

    // Hide loader on pageshow (handles back/forward cache)
    window.addEventListener('pageshow', function(event){
      if (window.VMTS) window.VMTS.hide();
    });
  </script>
</body>
</html>
